language: swift
osx_image: xcode11.2
env:
  global:
  - COMPANY="Brit Solucoes Integradas de Tecnologia Ltda."
  - COMPANY_ID="7PXVC8PJ97"
  - APP_NAME="MacMagazine"
  - 'DEVELOPER_NAME="iPhone Distribution: $COMPANY ($COMPANY_ID)"'
  - PROFILE_NAME="MacMagazine"
  - DESTINATION="platform=iOS Simulator,OS=13.2.2,name=iPhone 11 Pro"
  - BRANCH="release/4.0"
  secure: "H/bNaO+EaXo7YqP69PV3EpSHHjf52cEcVEG61nx8iaiUHt0jfOsaZb6bB5n8pRDM3rpT9r1V47pj7gZbQzRbFVPFncUzKFKePTV9NbsPV9AM6S/Ra7xHFxBBtrr+Jja7S4w33r4MmTYHFJujqQLtCr/otPbMjsO/DX7ch9aD6YkvQDS/KLTMYSd8PO5Nwyse0cyW7GXRK32IjhXrfFkWDbnaZHBwUVSW2MSBpW+rZt2T8HgwqyP9pkykEHlIis0HxFkFbR2BeDA+mFJvEtEimvkVmWMGghl5mrSF/ytn1T2XNVqLhlc91MTTYntZmuKXz4xnY5T3BDsa6csleUS7hB5c/X33vm2vcYLULWhkMCIJmtVWfcjDFNXuB1I195jQJ+i6EHdh8PLefCVH6xh3UGLP7UZVG2wQn/jmdU2eTMrMlFI3GIezr2nz3xDH+XcTAt6xteU1rBwdYO71ZZGk9aySY/qJOjVScT61ynbnPyv2QwWfWzYL+WoSk43mTOX9m7cy32l18tZA+kGVepDk34BcJx9XGXnELBOOejrGiqkNWhRbXAx13l8XIUjCdpe24XtqCnHdK3afK0Zw33vzpTcBNbd3CJB6M2gW2EOFRiArgf8KHySTokT37LZJwC+3aZPSm558GWVY8XOySAZJxZio7sTXnBQfjwgQYu4p6yE="
  secure: "w3F8ZL1mvjkCT524TFjVPBA4S5eDhSIcO9+ZtGUkoEp6t9VCp7+vzlg9fJDS9PM5uWgr9ejNgoNE+hXH9RzzuzsiSDFnz8r+ScCl/rBOdZm/329vCB1dkClJ6CKHtfhefuJ0tyTrGyD742/rDYKfNlvX04YO8oeIdRRCd/i2W0F+NuElIw15JIhiyNkY3ae+m5zL5EFyPn+OfUmPtIwbeqA1WqJoLlTgjQxOnbXx764kA0dVzHk6l+mPL6v/dZiy83EfpplHGPnfMRhxTHon7iWjaGJUplqG+cB41n9qXWPMVNMMnPoYfaR4mErIfLBgfxsbvUX564az6Y5t3FA+/kA1en9aj7SNDc9c8bOT25E1TBRg0Xyc3ryvWyH8sGiwKZPNPtRU3r/4WSUQjtfiRtX8Z5L2mV8HDibtXZ8Rf+D85mx3gojvZ55RO94NSbElvDYJnm6V2qHH7BpFWfBC+/KxUDz+bYOyahEydxJBRxVsKae3/L0ZpQBDUQ/MGf3A/xrTzjv4LGhyNJgfQw3Lh11wemSOXcgoC3MLKb//cSj+8iqWykC53lR78diq8KXhdiV/Q2GmdLu8KW375ruGwThXIjxo4BD+1E+nsnEOFt/VOO1uDsMK0Dd5+5FHa8Tu0oefP6hwB+ds9M9OQV/4oM5xZlCUywgkzkSN0Z0nlPk="
jobs:
  include:
  - stage: test
    script:
    - xcodebuild clean analyze test -project "$APP_NAME".xcodeproj -scheme "$APP_NAME" -destination "$DESTINATION"
  - stage: deploy
    before_script:
    - openssl aes-256-cbc -k "$ENCRYPTION_SECRET" -in scripts/certs/dist.cer.enc -d -a -out scripts/certs/dist.cer
    - openssl aes-256-cbc -k "$ENCRYPTION_SECRET" -in scripts/certs/dist.p12.enc -d -a -out scripts/certs/dist.p12
    script:
    - "./scripts/add-key.sh"
    - "./scripts/bundle.sh"
stages:
- name: test
  if: type = pull_request
- name: deploy
  if: type = push AND branch = release/4.0
